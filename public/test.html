<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoLite API - 批量测试工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: #6c757d;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .results {
            margin-top: 30px;
        }
        
        .stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            margin: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        .results-table thead,
        .results-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .results-table th,
        .results-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }
        
        .results-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #f8f9fa;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .controls {
                justify-content: center;
            }
            
            .stats {
                justify-content: center;
            }
            
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧪 GeoLite API 批量测试工具</h1>
            <p>批量查询IP地址和域名的地理位置信息</p>
        </div>

        <div class="input-section">
            <h3>📝 输入IP地址和域名（每行一个）：</h3>
            <textarea id="inputText" placeholder="请输入IP地址或域名，每行一个，例如：
8.8.8.8
google.com
github.com
baidu.com
114.114.114.114
cloudflare.com
youtube.com
facebook.com
twitter.com"></textarea>

            <div class="controls">
                <button class="btn" onclick="startBatchQuery()" id="queryBtn">
                    🚀 开始批量查询
                </button>
                <button class="btn secondary" onclick="loadSampleData()">
                    📄 加载示例数据
                </button>
                <button class="btn secondary" onclick="clearResults()">
                    🗑️ 清空结果
                </button>
                <label>
                    <input type="checkbox" id="exportCsv"> 直接导出CSV格式
                </label>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="results" id="results" style="display: none;">
            <h3>📊 查询结果</h3>
            <div class="stats" id="stats"></div>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        let currentResults = null;

        // 加载示例数据
        function loadSampleData() {
            const sampleData = `8.8.8.8
google.com
1.1.1.1
cloudflare.com
baidu.com
114.114.114.114
github.com
youtube.com
facebook.com
twitter.com
208.67.222.222
amazon.com
microsoft.com
apple.com
35.229.225.152
104.199.178.70
34.80.109.47
35.221.203.90
35.221.254.236
34.92.17.55
34.92.69.6
34.150.38.74
34.92.20.51
35.220.133.61
34.146.177.122
35.189.147.253
35.194.107.163
34.84.33.5
34.146.175.7
34.97.77.117
34.97.14.238
34.97.151.28
34.97.76.21
34.97.75.208
34.64.142.111
34.64.197.141
34.64.111.181
34.64.153.125
34.64.75.27
34.93.10.146
35.200.143.183
34.93.118.120
35.200.183.209
34.93.102.253
34.131.40.9
34.131.211.247
34.131.201.63
34.131.180.63
34.131.78.219
34.87.56.130
35.186.145.36
35.240.226.116
34.87.108.57
34.126.64.172
34.101.103.120
34.101.251.172
34.101.237.228
34.101.225.99
34.101.77.131
34.116.127.89
35.201.23.39
35.197.161.138
35.244.113.19
35.201.16.163
34.126.200.44
34.129.106.76
34.129.255.65
34.126.206.247
34.129.68.226
34.116.167.55
34.116.140.14
34.118.115.98
34.118.126.53
34.118.88.136
35.228.114.153
35.228.159.222
35.228.50.108
35.228.89.233
35.228.15.233
34.51.134.215
34.51.141.173
34.51.134.3
34.51.134.45
34.51.138.174
34.175.139.26
34.175.242.116
34.175.193.23
34.175.36.196
34.175.176.3
104.199.6.64
34.78.213.130
35.205.33.30
35.205.125.111
35.187.27.174
34.89.121.226
35.197.249.117
34.105.244.177
35.242.151.51
35.189.120.213
34.107.67.56
34.107.105.29
34.141.63.48
34.141.29.11
34.107.50.245
34.91.152.13
35.204.79.99
34.90.129.65
34.90.22.40
35.204.21.106
netflix.com`;
            document.getElementById('inputText').value = sampleData;
        }

        // 显示进度条
        function showProgress() {
            document.getElementById('progressBar').style.display = 'block';
            animateProgress();
        }

        // 进度条动画
        function animateProgress() {
            const progressFill = document.getElementById('progressFill');
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 90) {
                    clearInterval(interval);
                } else {
                    width += Math.random() * 10;
                    progressFill.style.width = width + '%';
                }
            }, 200);
        }

        // 隐藏进度条
        function hideProgress() {
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }

        // 开始批量查询
        async function startBatchQuery() {
            const inputText = document.getElementById('inputText').value.trim();
            if (!inputText) {
                alert('请输入IP地址或域名');
                return;
            }

            const queryBtn = document.getElementById('queryBtn');
            const resultsDiv = document.getElementById('results');

            queryBtn.disabled = true;
            queryBtn.innerHTML = '⏳ 查询中...';
            resultsDiv.style.display = 'block';
            showProgress();

            // 显示加载状态
            document.getElementById('resultsContent').innerHTML = 
                '<div class="loading">🔍 正在批量查询中，请稍候...</div>';

            try {
                const inputs = inputText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line);
                    
                const exportCsv = document.getElementById('exportCsv').checked;

                const response = await fetch('/api/batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: inputs,
                        format: exportCsv ? 'csv' : 'json'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (exportCsv) {
                    // 处理CSV下载
                    const csvData = await response.text();
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `geoip-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    document.getElementById('resultsContent').innerHTML = 
                        '<div class="loading">✅ CSV文件已下载完成！</div>';
                } else {
                    const data = await response.json();

                    if (data.success) {
                        currentResults = data;
                        displayResults(data);
                    } else {
                        throw new Error(data.message || data.error || '查询失败');
                    }
                }
            } catch (error) {
                console.error('查询错误:', error);
                document.getElementById('resultsContent').innerHTML =
                    `<div class="error">❌ 查询失败：${error.message}</div>`;
            } finally {
                queryBtn.disabled = false;
                queryBtn.innerHTML = '🚀 开始批量查询';
                hideProgress();
            }
        }

        // 显示查询结果
        function displayResults(data) {
            const stats = data.stats || data.statistics || {};
            const results = data.data || [];

            // 显示统计信息
            document.getElementById('stats').innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.total || results.length}</div>
                    <div>总数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #28a745;">${stats.success || 0}</div>
                    <div>成功</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="color: #dc3545;">${stats.error || 0}</div>
                    <div>失败</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.processing_time || stats.processing_time_ms || '0'}ms</div>
                    <div>处理时间</div>
                </div>
                <div class="stat-item">
                    <button class="btn success" onclick="exportToCsv()">📥 导出CSV</button>
                </div>
            `;

            // 显示详细结果表格
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th style="width: 150px;">输入</th>
                            <th style="width: 80px;">类型</th>
                            <th style="width: 130px;">IP地址</th>
                            <th style="width: 80px;">国家代码</th>
                            <th style="width: 100px;">国家名称</th>
                            <th style="width: 80px;">洲代码</th>
                            <th style="width: 80px;">状态</th>
                            <th style="width: 200px;">信息</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach((result, index) => {
                const statusClass = result.status === 'success' ? 'status-success' : 'status-error';
                const ip = result.ip || result.resolved_ip || '-';
                const message = result.message || (result.status === 'success' ? '查询成功' : '查询失败');

                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td title="${result.input}">${result.input}</td>
                        <td>${result.type || 'unknown'}</td>
                        <td>${ip}</td>
                        <td>${result.country_code || '-'}</td>
                        <td>${result.country_name || '-'}</td>
                        <td>${result.continent_code || '-'}</td>
                        <td class="${statusClass}">${result.status || 'error'}</td>
                        <td title="${message}">${message}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('resultsContent').innerHTML = tableHTML;
        }

        // 导出CSV
        function exportToCsv() {
            if (!currentResults) {
                alert('没有可导出的数据');
                return;
            }

            const results = currentResults.data || [];
            const headers = ['序号', '输入', '类型', 'IP地址', '解析IP', '国家代码', '国家名称', '洲代码', '洲名称', '状态', '信息'];
            const csvData = [headers.join(',')];

            results.forEach((result, index) => {
                const row = [
                    index + 1,
                    `"${(result.input || '').replace(/"/g, '""')}"`,
                    `"${(result.type || '').replace(/"/g, '""')}"`,
                    `"${(result.ip || '').replace(/"/g, '""')}"`,
                    `"${(result.resolved_ip || '').replace(/"/g, '""')}"`,
                    `"${(result.country_code || '').replace(/"/g, '""')}"`,
                    `"${(result.country_name || '').replace(/"/g, '""')}"`,
                    `"${(result.continent_code || '').replace(/"/g, '""')}"`,
                    `"${(result.continent_name || '').replace(/"/g, '""')}"`,
                    `"${(result.status || '').replace(/"/g, '""')}"`,
                    `"${(result.message || '').replace(/"/g, '""')}"`
                ];
                csvData.push(row.join(','));
            });

            const csvContent = csvData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geoip-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // 清空结果
        function clearResults() {
            document.getElementById('inputText').value = '';
            document.getElementById('results').style.display = 'none';
            currentResults = null;
            hideProgress();
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GeoLite API 批量测试工具已就绪');
        });
    </script>
</body>
</html>
